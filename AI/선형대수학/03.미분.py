# 미분
# 미분 = 순간적인 변화율

# 일상 예시:
# 자동차 속도계
# - 현재 속도 = 위치의 순간 변화율

# 평균 변화율 vs 순간 변화율
# 평균 변화율
# 서울 -> 부산 400km, 4시간 소요
# 평균 속도 = 400km/4h = 100km/h

# 순간 변화율(미분):
# - 특정 순간의 속도
# - 속도계가 보여주는 값
# - 시간 간격을 극한으로 줄임

# 기하학적 의미
# 미분 = 그래프에서 접선의 기울기

# y = x² 그래프에서:
# x=2에서 접선 기울기 = 4
# x=0에서 접선 기울기 = 0
# x=-2에서 접선 기울기 = -4

# 기본 미분 공식  

# 미분 표기법 
# y = f(x) 일때, 미분을 표현하는 방법:
# f'(x) <- 프라임 표기
# dy/dx <- 라이프니츠 표기
# d/dx f(x) <- 미분 연산자

# 기본 공식
# 상수의 미분
# f(x) = 5
# f'(x) = 0

# 거듭 제곱의 미분
# f(x) = x^n
# f'(x) = n * x^(n-1)

# 덧셈 법칙:
# (f + g)' = f' + g'

# f(x) = x² + x³
# f'(x) = 2x + 3x²


# 상수배 법칙:
# (c x f)' = c x f'
# f(x) = 3x²
# f'(x) = 3 × 2x = 6x


# 편미분
# 여러 변수가 있을 때, 하나만 변화시키고
# 나머지는 고정한 채로 미분

# f(x, y) = x² + y²

# x에 대한 편미분: ∂f/∂x = 2x (y는 상수 취급)
# y에 대한 편미분: ∂f/∂y = 2y (x는 상수 취급)

# ∂ (편미분 기호, '파셜' 또는 '델'이라고 읽음)
# ∂f/∂x = f를 x로 편미분


# AI에서 미분의 역할
# 손실 함수와 미분
# AI 학습의 핵심:
# 손실(오차)을 최소화하는 방향을 가중치를 조정

# 손실 함수를 가중치로 미분
# - 손실이 감소하는 방향을 알 수 있음
# - 그 방향으로 가중치 업데이트


# 그래디언트
# 모든 편미분을 벡터로 모은 것
# f(x,y) = x² + y² 일 때:
# 그래디언트 = [∂f/∂x, ∂f/∂y]
#           = [2x, 2y]

# (3, 4)에서 그래디언트 = [6, 8]

# 의미: 함수가 가장 급격히 증가하는 방향
# (반대 방향) = 가장 급격히 감소하는 방향

#  경사 하강법, 연쇄 법칙


# 경사 하강법 
# 현재 위치에서 가장 경사가 급한 방향 확인
# 그 방향으로 한걸음 이동
# 반복 -> 결국 가장 낮은 곳에 도착

# AI
# 현재 손실에서 그래디언트 계산
# 손실이 줄어드는 방향으로 가중치를 조정
# 반복 -> 최소 손실에 도달



# 수학적 표현
# 목표: f(x)를 최소로 만드는 x 찾기
# 경상 하강법:
# x_new = x_old - η × f'(x_old)

# η (eta) = 학습률 (learning rate)
# f'(x) = 기울기 (그래디언트)

# 기울기가 양수 (+) -> 오른쪽으로 가면 증가
#                   -> 왼쪽으로 가야 감소
#                   -> 빼기 사용

# 기울기가 음수 (-) -> 왼쪽으로 가면 증가
#                   -> 오른쪽으로 가야 감소
#                   -> 빼기 사용

# 결론 : 항상 기울기를 빼면 최솟값 방향으로 이동!

# 학습률 (learning Rate)
# 학습률 = 한 번에 얼마나 크게 이동할지 결정
# η = 0.001 => 아주 작은 걸음(느리지만 안정적)
# η = 0.1 => 적당한 걸음
# η = 1.0 => 큰 걸음(빠르지만 불안정)

# 일반적인 시작점:
# η = 0.001 ~ 0.1 사이에서 시작하여 실험적으로 조정

# 실제 예제 코드
import numpy as np

# 목표 함수: f(x) = x²
# 미분: f'(x) = 2x
# 목표: x²을 최소화하는 x 찾기 (정답: x=0)

def f(x):
    return x**2

def df(x):  # 미분 함수
    return 2*x

# 경사 하강법 실행
x = 10.0  # 시작점
학습률 = 0.1
반복횟수 = 20

print("경사 하강법으로 최솟값 찾기")
print(f"시작점: x = {x}, f(x) = {f(x)}")

for i in range(반복횟수):
    기울기 = df(x)
    x = x - 학습률 * 기울기  # 경사 하강법 공식
    print(f"반복 {i+1}: x = {x:.4f}, f(x) = {f(x):.4f}, 기울기 = {기울기:.4f}")

print(f"\n최종 결과: x = {x:.4f}, f(x) = {f(x):.6f}")

# 핵심 정리
# 1. 미분 = 순간 변화율 = 접선의 기울기
# 2. 편미분: 여러 변수 중 하나만 변화시키며 미분
# 3. 그래디언트: 모든 편미분을 벡터로 모은 것
# 4. 경사 하강법: 그래디언트의 반대 방향으로 이동하여 최솟값 찾기
# 5. 학습률: 이동 보폭 조절 (너무 크면 불안정, 너무 작으면 느림)
# 6. AI 학습 = 경사 하강법으로 손실 함수를 최소화하는 과정

###################################################################################################################
# 실습 1

# -*- coding: utf-8 -*-
"""
미분 연습 문제 1 ~ 3번을 파이썬으로 정리한 코드입니다.

1. 단변수 함수의 미분식 출력
   a) f(x) = 3x^2
   b) f(x) = x^3 + 2x
   c) f(x) = 5x^4 - 3x^2 + 7

2. 다변수 함수 f(x, y) = 3x^2 + 2xy + y^2 의 편미분
   - x에 대한 편미분 식
   - y에 대한 편미분 식

3. f(x) = x^3 의 x=2 에서의 미분값을
   - 수치 미분(중심 차분)으로 계산
"""

# ===============================
# 1. 단변수 함수와 도함수 정의
# ===============================

# (1-a) f(x) = 3x^2
def f1(x):
    """f1(x) = 3x^2"""
    return 3 * x**2

def f1_prime(x):
    """
    f1'(x) = 6x  (수학적으로 직접 미분한 결과를 코드로 구현)
    """
    return 6 * x


# (1-b) f(x) = x^3 + 2x
def f2(x):
    """f2(x) = x^3 + 2x"""
    return x**3 + 2 * x

def f2_prime(x):
    """
    f2'(x) = 3x^2 + 2
    - x^3  ->  3x^2
    - 2x   ->  2
    """
    return 3 * x**2 + 2


# (1-c) f(x) = 5x^4 - 3x^2 + 7
def f3(x):
    """f3(x) = 5x^4 - 3x^2 + 7"""
    return 5 * x**4 - 3 * x**2 + 7

def f3_prime(x):
    """
    f3'(x) = 20x^3 - 6x
    - 5x^4 -> 20x^3
    - -3x^2 -> -6x
    - 상수 7의 미분은 0
    """
    return 20 * x**3 - 6 * x


# ===============================
# 2. 다변수 함수와 편미분 정의
# ===============================

def f_xy(x, y):
    """f(x, y) = 3x^2 + 2xy + y^2"""
    return 3 * x**2 + 2 * x * y + y**2

def df_dx(x, y):
    """
    x에 대한 편미분 ∂f/∂x
    - 3x^2     -> 6x
    - 2xy      -> 2y   (y는 상수 취급)
    - y^2      -> 0    (x와 무관)
    => ∂f/∂x = 6x + 2y
    """
    return 6 * x + 2 * y

def df_dy(x, y):
    """
    y에 대한 편미분 ∂f/∂y
    - 3x^2     -> 0    (y와 무관)
    - 2xy      -> 2x
    - y^2      -> 2y
    => ∂f/∂y = 2x + 2y
    """
    return 2 * x + 2 * y


# ===============================
# 3. 수치 미분 (중심 차분)
# ===============================

def numerical_derivative(f, x, h=1e-5):
    """
    주어진 함수 f에 대해, x에서의 수치 미분 값을
    '중심 차분' 방식으로 근사 계산한다.

    f'(x) ≈ ( f(x + h) - f(x - h) ) / (2h)

    - h는 아주 작은 양수 (기본값: 1e-5)
    - h가 너무 크면 오차가 커지고, 너무 작으면 부동소수점 오차가 커질 수 있음
    """
    return (f(x + h) - f(x - h)) / (2 * h)


# ===============================
# 메인 실행부: 결과 출력
# ===============================
if __name__ == "__main__":
    # 1번: 도함수 식과 예시 값 출력
    x_value = 2  # 예시로 x=2에서 값 확인

    print("=== 1. 단변수 함수 미분 ===")
    print(f"f1(x) = 3x^2,    f1'(x) = 6x  → f1'({x_value}) = {f1_prime(x_value)}")
    print(f"f2(x) = x^3+2x,  f2'(x) = 3x^2+2  → f2'({x_value}) = {f2_prime(x_value)}")
    print(f"f3(x) = 5x^4-3x^2+7,  f3'(x) = 20x^3-6x  → f3'({x_value}) = {f3_prime(x_value)}")
    print()

    # 2번: 다변수 편미분 (예시: x=1, y=2에서 값 확인)
    x0, y0 = 1, 2
    print("=== 2. f(x, y) = 3x^2 + 2xy + y^2 의 편미분 ===")
    print("∂f/∂x = 6x + 2y  → ∂f/∂x(1,2) =", df_dx(x0, y0))
    print("∂f/∂y = 2x + 2y  → ∂f/∂y(1,2) =", df_dy(x0, y0))
    print()

    # 3번: f(x) = x^3 의 x=2에서의 수치 미분
    def f(x):
        return x**3

    x0 = 2
    deriv_num = numerical_derivative(f, x0)
    deriv_exact = 3 * x0**2  # 이론값 3x^2

    print("=== 3. 수치 미분으로 f(x)=x^3 의 x=2에서의 도함수 값 ===")
    print("수치 미분값 (중심 차분):", deriv_num)
    print("이론적인 정확한 값   :", deriv_exact)
    print("오차(수치 - 이론)    :", deriv_num - deriv_exact)
