<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arduino LED Control (Web Serial)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Noto Sans KR", sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .card {
      background: #ffffff;
      padding: 40px 60px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      text-align: center;
      min-width: 320px;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 20px;
    }

    .btn {
      border: none;
      border-radius: 20px;
      padding: 10px 26px;
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s;
      margin: 0 6px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none !important;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-connect {
      background: #3498db;
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.5);
      margin-bottom: 20px;
    }

    .btn-on {
      background: #1abc9c;
      box-shadow: 0 4px 10px rgba(26, 188, 156, 0.5);
    }

    .btn-off {
      background: #e74c3c;
      box-shadow: 0 4px 10px rgba(231, 76, 60, 0.5);
    }

    .status {
      margin-top: 12px;
      font-size: 14px;
      color: #555;
    }

    .status strong {
      font-weight: 700;
    }

    .status-value.on {
      color: #1abc9c;
    }

    .status-value.off {
      color: #e74c3c;
    }

    .status-value.disconnected {
      color: #7f8c8d;
    }

    .status-value.error {
      color: #c0392b;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Arduino LED Control</h1>

    <!-- 시리얼 포트 연결 버튼 -->
    <button class="btn btn-connect" id="btnConnect">Connect Serial</button>

    <div style="margin-bottom: 16px;"></div>

    <!-- LED ON / OFF 제어 버튼 -->
    <button class="btn btn-on" id="btnOn" disabled>LED ON</button>
    <button class="btn btn-off" id="btnOff" disabled>LED OFF</button>

    <div class="status">
      Serial:
      <strong id="serialStatus" class="status-value disconnected">disconnected</strong>
      <br />
      LED:
      <strong id="ledStatus" class="status-value off">off</strong>
    </div>
  </div>

  <script>
    // Web Serial 객체들
    let port = null;
    let writer = null;

    const btnConnect = document.getElementById("btnConnect");
    const btnOn = document.getElementById("btnOn");
    const btnOff = document.getElementById("btnOff");
    const serialStatus = document.getElementById("serialStatus");
    const ledStatus = document.getElementById("ledStatus");

    function setSerialStatus(text, cls) {
      serialStatus.textContent = text;
      serialStatus.className = "status-value " + cls;
    }

    function setLedStatus(text, cls) {
      ledStatus.textContent = text;
      ledStatus.className = "status-value " + cls;
    }

    // 시리얼 포트 선택 및 오픈
    async function connectSerial() {
      try {
        if (!("serial" in navigator)) {
          alert("이 브라우저는 Web Serial API를 지원하지 않습니다. (Chrome/Edge 권장)");
          return;
        }

        // 1) 사용자에게 포트 선택 창 표시
        port = await navigator.serial.requestPort();

        // 2) 선택된 포트 오픈 (아두이노와 속도 맞추기: 9600)
        await port.open({ baudRate: 9600 });

        // 3) 쓰기용 writer 가져오기
        writer = port.writable.getWriter();

        setSerialStatus("connected", "on");
        btnOn.disabled = false;
        btnOff.disabled = false;
        btnConnect.textContent = "Reconnect";

      } catch (err) {
        console.error("Serial connection failed:", err);
        setSerialStatus("error", "error");
        btnOn.disabled = true;
        btnOff.disabled = true;
      }
    }

    // 한 글자(ch)를 시리얼로 전송
    async function sendChar(ch) {
      try {
        if (!writer) {
          alert("먼저 'Connect Serial' 버튼으로 포트를 연결하세요.");
          return;
        }
        const data = new TextEncoder().encode(ch); // "1" -> Uint8Array([0x31])
        await writer.write(data);
      } catch (err) {
        console.error("Write failed:", err);
        setSerialStatus("error", "error");
      }
    }

    // 버튼 이벤트 등록
    btnConnect.addEventListener("click", connectSerial);

    btnOn.addEventListener("click", async () => {
      await sendChar("1"); // 아두이노: '1' -> LED ON
      setLedStatus("on", "on");
    });

    btnOff.addEventListener("click", async () => {
      await sendChar("0"); // '1' 이 외의 값 -> LED OFF(초기화)
      setLedStatus("off", "off");
    });

    // 페이지를 떠날 때 시리얼 포트 정리 (선택 사항)
    window.addEventListener("beforeunload", async () => {
      try {
        if (writer) {
          await sendChar("0"); // 끄고 나가기
          writer.releaseLock();
        }
        if (port) await port.close();
      } catch (e) {
        // 무시
      }
    });
  </script>
</body>
</html>
